<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#4f46e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>HealthHub Pro | Ultimate</title>

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
    :root {
        --text: #1e293b;
        --text-sub: #64748b;
        --primary: #4f46e5;
        --secondary: #0ea5e9;
        --accent: #ec4899;
        
        /* Glass Vars */
        --glass-bg: rgba(255, 255, 255, 0.75);
        --glass-border: rgba(255, 255, 255, 0.6);
        --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        --input-bg: rgba(255, 255, 255, 0.5);
        --radius: 28px;
    }

    [data-theme="dark"] {
        --text: #f8fafc;
        --text-sub: #94a3b8;
        --primary: #818cf8;
        --secondary: #38bdf8;
        --glass-bg: rgba(15, 23, 42, 0.75);
        --glass-border: rgba(255, 255, 255, 0.08);
        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
        --input-bg: rgba(0, 0, 0, 0.3);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
        margin: 0; font-family: 'Outfit', sans-serif;
        min-height: 100vh; color: var(--text);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex; justify-content: center; align-items: center;
        overflow: hidden;
    }

    /* --- LAYOUT & RESPONSIVENESS --- */
    .app-wrapper { width: 100%; height: 100vh; position: relative; }

    /* Desktop/Tablet Card Style */
    @media (min-width: 769px) {
        .app-wrapper { display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.1); }
        .main-card {
            width: 420px; height: 85vh; max-height: 850px;
            border-radius: var(--radius);
        }
    }

    .main-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        box-shadow: var(--glass-shadow);
        display: flex; flex-direction: column;
        width: 100%; 
        /* Fix for mobile browsers showing address bars */
        height: 100dvh; 
        position: relative; overflow: hidden;
        transition: 0.3s;
    }

    /* Content Area - Fix for scrolling */
    .content-area { 
        flex: 1; 
        overflow-y: auto; 
        overflow-x: hidden;
        padding: 25px; 
        /* Crucial: Extra padding so nav bar doesn't hide content */
        padding-bottom: 120px; 
        -webkit-overflow-scrolling: touch;
    }
    .content-area::-webkit-scrollbar { width: 0; }

    /* --- UI ELEMENTS --- */
    h1 { font-size: 1.8rem; margin: 0; font-weight: 700; letter-spacing: -0.5px; }
    h2 { font-size: 1.3rem; margin: 0 0 15px 0; font-weight: 600; }
    p.sub { color: var(--text-sub); font-size: 0.9rem; margin: 5px 0 25px 0; }
    
    label { font-size: 0.75rem; font-weight: 700; color: var(--text-sub); display: block; margin: 0 0 6px 4px; text-transform: uppercase; letter-spacing: 0.5px; }

    input, select {
        width: 100%; padding: 14px 18px; border-radius: 16px;
        border: 1px solid var(--glass-border); background: var(--input-bg);
        color: var(--text); font-family: inherit; font-size: 1rem;
        transition: 0.2s; margin-bottom: 20px;
    }
    input:focus, select:focus { border-color: var(--primary); background: rgba(255,255,255,0.8); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15); }
    [data-theme="dark"] input:focus { background: rgba(0,0,0,0.5); }

    /* --- BUTTONS --- */
    .btn-primary {
        width: 100%; padding: 16px; border: none; border-radius: 18px;
        background: linear-gradient(135deg, var(--primary), #8b5cf6);
        color: white; font-size: 1rem; font-weight: 600; cursor: pointer;
        box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4);
        transition: 0.2s;
    }
    .btn-primary:active { transform: scale(0.97); }

    .btn-icon { background: none; border: none; font-size: 1.1rem; color: var(--text-sub); cursor: pointer; padding: 8px; }
    
    /* --- NAV BAR --- */
    .nav-bar {
        position: absolute; bottom: 0; left: 0; right: 0;
        background: var(--glass-bg); border-top: 1px solid var(--glass-border);
        backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
        padding: 10px 20px 25px 20px; /* More bottom padding for phones with bars */
        display: flex; justify-content: space-around; z-index: 50;
    }
    .nav-item {
        border: none; background: none; color: var(--text-sub);
        display: flex; flex-direction: column; align-items: center;
        gap: 4px; cursor: pointer; transition: 0.3s;
        flex: 1;
    }
    .nav-item.active { color: var(--primary); transform: translateY(-4px); }
    .nav-item i { font-size: 1.5rem; }
    .nav-item span { font-size: 0.7rem; font-weight: 600; }

    /* --- SECTIONS (View Management) --- */
    .view-section { display: none; width: 100%; animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .view-section.active { display: block; }
    @keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

    /* --- LOGIN & PROFILE --- */
    .profile-upload {
        width: 100px; height: 100px; margin: 0 auto 20px; border-radius: 50%;
        background: var(--input-bg); border: 2px dashed var(--glass-border);
        display: flex; align-items: center; justify-content: center;
        overflow: hidden; cursor: pointer; position: relative;
    }
    .profile-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }

    /* --- WATER CHART --- */
    .water-chart { position: relative; width: 200px; height: 200px; margin: 0 auto 20px; }
    svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    circle { fill: none; stroke-width: 16; stroke-linecap: round; }
    .track { stroke: rgba(0,0,0,0.05); } [data-theme="dark"] .track { stroke: rgba(255,255,255,0.05); }
    .progress { 
        stroke: var(--secondary); stroke-dasharray: 500; stroke-dashoffset: 500; 
        transition: 1s ease; filter: drop-shadow(0 0 6px var(--secondary));
    }
    .center-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); text-align: center; }

    /* --- MEDICINE UI --- */
    .med-card {
        background: var(--input-bg); border: 1px solid var(--glass-border);
        padding: 16px; border-radius: 20px; margin-bottom: 12px;
        display: flex; justify-content: space-between; align-items: center;
        transition: 0.2s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    }
    .med-info { display: flex; align-items: center; gap: 12px; }
    .med-icon { 
        width: 42px; height: 42px; border-radius: 12px; 
        background: rgba(236, 72, 153, 0.15); color: #ec4899;
        display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
    }

    /* Dose Selector */
    .dose-grid { display: flex; gap: 8px; margin-bottom: 20px; }
    .dose-btn {
        flex: 1; padding: 10px; border-radius: 12px; border: 1px solid var(--glass-border);
        background: var(--input-bg); color: var(--text-sub); cursor: pointer;
    }
    .dose-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* Day Selector */
    .day-grid { display: flex; justify-content: space-between; gap: 4px; margin-bottom: 20px; }
    .day-pill {
        width: 36px; height: 36px; border-radius: 10px;
        border: 1px solid var(--glass-border); background: var(--input-bg);
        display: flex; align-items: center; justify-content: center;
        font-size: 0.75rem; font-weight: 700; color: var(--text-sub); cursor: pointer;
    }
    .day-pill.selected { background: var(--primary); color: white; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }

    /* --- ALERT MODAL --- */
    .alert-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
        z-index: 100; display: none; align-items: center; justify-content: center;
    }
    .alert-box {
        background: #fff; width: 85%; max-width: 320px; padding: 30px; border-radius: 30px;
        text-align: center; animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    [data-theme="dark"] .alert-box { background: #1e293b; }
    @keyframes pop { from{transform:scale(0.8);opacity:0;} to{transform:scale(1);opacity:1;} }

    .theme-btn { position: absolute; top: 20px; right: 20px; z-index: 50; background: var(--input-bg); border: 1px solid var(--glass-border); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; color: var(--text); }
</style>
</head>
<body>

<div class="app-wrapper">
    <button class="theme-btn" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>

    <div class="main-card">
        
        <div style="padding: 25px 25px 0; display:flex; justify-content:space-between; align-items:center;">
            <div id="u_header" style="display:none; align-items:center; gap:12px;">
                <img id="head_avatar" src="" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                <div>
                    <div style="font-size:0.75rem; opacity:0.7;" data-i18n="welcome">Welcome back,</div>
                    <div id="head_name" style="font-weight:700;">User</div>
                </div>
            </div>
            <div id="clock" style="font-family:monospace; font-weight:700; font-size:1.1rem; opacity:0.8; margin-left:auto;">00:00</div>
        </div>

        <div class="content-area">

            <div id="view_login" class="view-section active">
                <div style="text-align:center; padding-top:10px;">
                    <h1 style="margin-bottom:5px;" data-i18n="appTitle">HealthHub Pro</h1>
                    <p class="sub" data-i18n="appSub">Ultimate Wellness Companion</p>

                    <label for="f_img" class="profile-upload">
                        <i class="fas fa-camera" id="icon_upload" style="font-size:1.5rem; opacity:0.5;"></i>
                        <img id="img_preview">
                    </label>
                    <input type="file" id="f_img" hidden accept="image/*" onchange="previewImg(event)">

                    <div style="text-align:left;">
                        <label data-i18n="lblName">Your Name</label>
                        <input type="text" id="f_name" data-i18n-ph="phName" placeholder="Enter name">

                        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;">
                            <div>
                                <label data-i18n="lblDob">Date of Birth</label>
                                <input type="date" id="f_dob" onchange="calcAge()">
                            </div>
                            <div>
                                <label data-i18n="lblAge">Age</label>
                                <input type="text" id="f_age" readonly placeholder="--" style="text-align:center; font-weight:700;">
                            </div>
                        </div>

                        <label data-i18n="lblLang">Language</label>
                        <select id="f_lang" onchange="changeLanguage(this.value)">
                            <option value="en">English</option>
                            <option value="hi">Hindi (हिंदी)</option>
                            <option value="gu">Gujarati (ગુજરાતી)</option>
                        </select>
                    </div>

                    <button class="btn-primary" onclick="doLogin()" data-i18n="btnStart">Start Journey</button>
                    <p style="font-size:0.75rem; margin-top:15px; opacity:0.6;" data-i18n="noteLock">Enables Lock Screen Notifications</p>
                </div>
            </div>

            <div id="view_water_setup" class="view-section">
                <h2 data-i18n="hWaterSetup">Hydration Plan</h2>
                <p class="sub" data-i18n="subWaterSetup">Set your daily schedule.</p>
                
                <label data-i18n="lblWeight">Weight (kg)</label>
                <input type="number" id="w_weight" data-i18n-ph="phWeight" placeholder="e.g. 70">
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div><label data-i18n="lblWake">Wake Up</label><input type="time" id="w_wake" value="07:00"></div>
                    <div><label data-i18n="lblBed">Bed Time</label><input type="time" id="w_bed" value="23:00"></div>
                </div>

                <label data-i18n="lblInterval">Reminder Interval</label>
                <select id="w_interval">
                    <option value="2" data-i18n="opt2min">2 Mins (Demo Mode)</option>
                    <option value="30" data-i18n="opt30min">Every 30 Mins</option>
                    <option value="45" data-i18n="opt45min">Every 45 Mins</option>
                    <option value="60" selected data-i18n="opt60min">Every 1 Hour</option>
                </select>

                <button class="btn-primary" onclick="initWater()" data-i18n="btnCalc">Calculate & Begin</button>
            </div>

            <div id="view_water" class="view-section">
                <h2 style="text-align:center;" data-i18n="hWaterTrack">Hydration Tracker</h2>
                
                <div class="water-chart">
                    <svg><circle cx="100" cy="100" r="90" class="track"></circle><circle cx="100" cy="100" r="90" class="progress" id="w_ring"></circle></svg>
                    <div class="center-text">
                        <div id="w_timer" style="font-size:2rem; font-weight:700;">00:00</div>
                        <div style="font-size:0.8rem; opacity:0.7;" data-i18n="lblNextSip">Next Sip</div>
                    </div>
                </div>

                <div style="display:flex; gap:15px; margin-bottom:25px;">
                    <div style="flex:1; background:var(--input-bg); padding:15px; border-radius:20px; text-align:center;">
                        <i class="fas fa-glass-water" style="color:var(--secondary); margin-bottom:5px;"></i>
                        <div id="w_count" style="font-weight:700; font-size:1.2rem;">0</div>
                        <div style="font-size:0.7rem;" data-i18n="lblDrunk">Drunk</div>
                    </div>
                    <div style="flex:1; background:var(--input-bg); padding:15px; border-radius:20px; text-align:center;">
                        <i class="fas fa-bullseye" style="color:var(--accent); margin-bottom:5px;"></i>
                        <div id="w_goal" style="font-weight:700; font-size:1.2rem;">0L</div>
                        <div style="font-size:0.7rem;" data-i18n="lblGoal">Goal</div>
                    </div>
                </div>

                <button class="btn-primary" onclick="addWater()" data-i18n="btnDrink"> Drink (250ml)</button>
            </div>

            <div id="view_meds" class="view-section">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 data-i18n="hMeds">Medications</h2>
                    <button class="btn-primary" style="width:auto; padding:8px 16px; border-radius:12px; font-size:0.8rem;" onclick="openMedForm()" data-i18n="btnAdd">+ Add</button>
                </div>

                <div id="med_list_container" style="padding-bottom: 20px;">
                    <p style="text-align:center; opacity:0.5; margin-top:50px;" data-i18n="noMeds">No reminders set.</p>
                </div>
            </div>

            <div id="view_med_form" class="view-section">
                <h2 id="form_title" data-i18n="hAddMed">Add Medication</h2>
                
                <input type="hidden" id="m_edit_id"> <label data-i18n="lblMedName">Medicine Name</label>
                <input type="text" id="m_name" data-i18n-ph="phMedName" placeholder="e.g. Aspirin">

                <label data-i18n="lblFreq">Frequency (Doses per day)</label>
                <div class="dose-grid">
                    <button class="dose-btn active" onclick="setDose(1)">1x</button>
                    <button class="dose-btn" onclick="setDose(2)">2x</button>
                    <button class="dose-btn" onclick="setDose(3)">3x</button>
                    <button class="dose-btn" onclick="setDose(4)">4x</button>
                </div>

                <label data-i18n="lblSetTime">Set Time(s)</label>
                <div id="time_inputs_container" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                    <input type="time">
                </div>

                <label data-i18n="lblRepeat">Repeat Days</label>
                <div class="day-grid" id="day_selector">
                    </div>

                <label data-i18n="lblNote">Voice Note (Optional)</label>
                <input type="text" id="m_note" data-i18n-ph="phNote" placeholder="Spoken instruction...">

                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" style="background:var(--input-bg); color:var(--text);" onclick="cancelMedForm()" data-i18n="btnCancel">Cancel</button>
                    <button class="btn-primary" onclick="saveMed()" data-i18n="btnSave">Save</button>
                </div>
            </div>

        </div>

        <div class="nav-bar" id="nav_bar" style="display:none;">
            <button class="nav-item active" onclick="nav('water')" id="btn_nav_water">
                <i class="fas fa-tint"></i><span data-i18n="navWater">Water</span>
            </button>
            <button class="nav-item" onclick="nav('meds')" id="btn_nav_meds">
                <i class="fas fa-pills"></i><span data-i18n="navMeds">Meds</span>
            </button>
        </div>

    </div>
</div>

<div class="alert-overlay" id="alert_modal">
    <div class="alert-box">
        <i class="fas fa-bell" style="font-size:3rem; color:var(--accent); margin-bottom:15px;"></i>
        <h2 id="alert_title" data-i18n="alertTitle">Alert</h2>
        <p id="alert_body" class="sub" data-i18n="alertBody">Time to take action</p>
        <button class="btn-primary" onclick="stopAlert()" data-i18n="btnDismiss">I'm on it</button>
    </div>
</div>

<script>
    /* --- TRANSLATION DATA --- */
    const translations = {
        en: {
            appTitle: "HealthHub Pro",
            appSub: "Ultimate Wellness Companion",
            welcome: "Welcome back,",
            lblName: "Your Name",
            phName: "Enter name",
            lblDob: "Date of Birth",
            lblAge: "Age",
            lblLang: "Language",
            btnStart: "Start Journey",
            noteLock: "Enables Lock Screen Notifications",
            hWaterSetup: "Hydration Plan",
            subWaterSetup: "Set your daily schedule.",
            lblWeight: "Weight (kg)",
            phWeight: "e.g. 70",
            lblWake: "Wake Up",
            lblBed: "Bed Time",
            lblInterval: "Reminder Interval",
            opt2min: "2 Mins (Demo Mode)",
            opt30min: "Every 30 Mins",
            opt45min: "Every 45 Mins",
            opt60min: "Every 1 Hour",
            btnCalc: "Calculate & Begin",
            hWaterTrack: "Hydration Tracker",
            lblNextSip: "Next Sip",
            lblDrunk: "Drunk",
            lblGoal: "Goal",
            btnDrink: "Drink (250ml)",
            hMeds: "Medications",
            btnAdd: "+ Add",
            noMeds: "No reminders set.",
            hAddMed: "Add Medication",
            lblMedName: "Medicine Name",
            phMedName: "e.g. Aspirin",
            lblFreq: "Frequency (Doses per day)",
            lblSetTime: "Set Time(s)",
            lblRepeat: "Repeat Days",
            lblNote: "Voice Note (Optional)",
            phNote: "Spoken instruction...",
            btnCancel: "Cancel",
            btnSave: "Save",
            navWater: "Water",
            navMeds: "Meds",
            alertTitle: "Alert",
            alertBody: "Time to take action",
            btnDismiss: "I'm on it"
        },
        hi: {
            appTitle: "हेल्थहब प्रो",
            appSub: "आपका स्वास्थ्य साथी",
            welcome: "वापसी पर स्वागत है,",
            lblName: "आपका नाम",
            phName: "नाम दर्ज करें",
            lblDob: "जन्म तिथि",
            lblAge: "आयु",
            lblLang: "भाषा",
            btnStart: "यात्रा शुरू करें",
            noteLock: "लॉक स्क्रीन सूचनाएं सक्षम करता है",
            hWaterSetup: "हाइड्रेशन योजना",
            subWaterSetup: "अपनी दिनचर्या सेट करें",
            lblWeight: "वजन (किलो)",
            phWeight: "जैसे 70",
            lblWake: "जागने का समय",
            lblBed: "सोने का समय",
            lblInterval: "रिमाइंडर अंतराल",
            opt2min: "2 मिनट (डेमो मोड)",
            opt30min: "हर 30 मिनट",
            opt45min: "हर 45 मिनट",
            opt60min: "हर 1 घंटे",
            btnCalc: "गणना करें और शुरू करें",
            hWaterTrack: "हाइड्रेशन ट्रैकर",
            lblNextSip: "अगला घूँट",
            lblDrunk: "पी लिया",
            lblGoal: "लक्ष्य",
            btnDrink: "पानी पिएं (250ml)",
            hMeds: "दवाइयाँ",
            btnAdd: "+ जोड़ें",
            noMeds: "कोई रिमाइंडर सेट नहीं है",
            hAddMed: "दवा जोड़ें",
            lblMedName: "दवा का नाम",
            phMedName: "जैसे एस्पिरिन",
            lblFreq: "आवृत्ति (प्रति दिन खुराक)",
            lblSetTime: "समय सेट करें",
            lblRepeat: "दोहराने के दिन",
            lblNote: "वॉइस नोट (वैकल्पिक)",
            phNote: "बोला गया निर्देश...",
            btnCancel: "रद्द करें",
            btnSave: "सहेजें",
            navWater: "पानी",
            navMeds: "दवा",
            alertTitle: "चेतावनी",
            alertBody: "कार्रवाई करने का समय",
            btnDismiss: "मैं समझ गया"
        },
        gu: {
            appTitle: "હેલ્થહબ પ્રો",
            appSub: "તમારો સ્વાસ્થ્ય સાથી",
            welcome: "સ્વાગત છે,",
            lblName: "તમારું નામ",
            phName: "નામ દાખલ કરો",
            lblDob: "જન્મ તારીખ",
            lblAge: "ઉંમર",
            lblLang: "ભાષા",
            btnStart: "શરૂ કરો",
            noteLock: "લોક સ્ક્રીન સૂચનાઓ સક્ષમ કરે છે",
            hWaterSetup: "હાઇડ્રેશન પ્લાન",
            subWaterSetup: "તમારું દૈનિક શેડ્યૂલ સેટ કરો",
            lblWeight: "વજન (કિલો)",
            phWeight: "જેમ કે 70",
            lblWake: "જાગવાનો સમય",
            lblBed: "સૂવાનો સમય",
            lblInterval: "રિમાઇન્ડર અંતરાલ",
            opt2min: "2 મિનિટ (ડેમો)",
            opt30min: "દર 30 મિનિટે",
            opt45min: "દર 45 મિનિટે",
            opt60min: "દર 1 કલાકે",
            btnCalc: "ગણતરી કરો અને શરૂ કરો",
            hWaterTrack: "હાઇડ્રેશન ટ્રેકર",
            lblNextSip: "આગળનો ઘૂંટડો",
            lblDrunk: "પીધું",
            lblGoal: "લક્ષ્ય",
            btnDrink: "પાણી પીવો (250ml)",
            hMeds: "દવાઓ",
            btnAdd: "+ ઉમેરો",
            noMeds: "કોઈ રિમાઇન્ડર સેટ નથી",
            hAddMed: "દવા ઉમેરો",
            lblMedName: "દવાનું નામ",
            phMedName: "જેમ કે એસ્પિરિન",
            lblFreq: "આવર્તન (દિવસ દીઠ ડોઝ)",
            lblSetTime: "સમય સેટ કરો",
            lblRepeat: "પુનરાવર્તિત દિવસો",
            lblNote: "વોઇસ નોટ (વૈકલ્પિક)",
            phNote: "સૂચના...",
            btnCancel: "રદ કરો",
            btnSave: "સાચવો",
            navWater: "પાણી",
            navMeds: "દવા",
            alertTitle: "ચેતવણી",
            alertBody: "કાર્ય કરવાનો સમય",
            btnDismiss: "હું સમજી ગયો"
        }
    };

    let currentLang = 'en';

    function changeLanguage(lang) {
        currentLang = lang;
        const t = translations[lang];
        
        // Update Text Content
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(t[key]) el.innerText = t[key];
        });

        // Update Placeholders
        document.querySelectorAll('[data-i18n-ph]').forEach(el => {
            const key = el.getAttribute('data-i18n-ph');
            if(t[key]) el.placeholder = t[key];
        });
    }

    /* --- 1. CORE UTILS & THEME --- */
    function toggleTheme() {
        const b = document.body;
        b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    }

    const UI = {
        views: ['view_login','view_water_setup','view_water','view_meds','view_med_form'],
        show: (id) => {
            UI.views.forEach(v => document.getElementById(v).classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    };

    /* --- 2. LOGIN & PROFILE LOGIC --- */
    function previewImg(e) {
        const file = e.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('img_preview').src = ev.target.result;
                document.getElementById('img_preview').style.display = 'block';
                document.getElementById('icon_upload').style.display = 'none';
                document.getElementById('head_avatar').src = ev.target.result;
            }
            reader.readAsDataURL(file);
        }
    }

    function calcAge() {
        const dob = document.getElementById('f_dob').value;
        if(dob) {
            const diff = Date.now() - new Date(dob).getTime();
            const ageDate = new Date(diff);
            document.getElementById('f_age').value = Math.abs(ageDate.getUTCFullYear() - 1970);
        }
    }

    function doLogin() {
        const name = document.getElementById('f_name').value;
        if(!name) return alert("Please enter your name.");
        
        document.getElementById('head_name').innerText = name;
        document.getElementById('u_header').style.display = 'flex';
        AudioSys.init();
        if('Notification' in window) Notification.requestPermission();
        
        // IMMEDIATE ACCESS: Show Nav bar and Default to Water Setup
        document.getElementById('nav_bar').style.display = 'flex';
        nav('water'); // Default tab
    }

    // --- NAVIGATION LOGIC ---
    function nav(loc) {
        // Handle Active State
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(loc === 'water' ? 'btn_nav_water' : 'btn_nav_meds').classList.add('active');
        
        if(loc === 'water') {
            // Smart Navigation: Go to setup if water not set, else tracker
            if(water.goal > 0) UI.show('view_water');
            else UI.show('view_water_setup');
        } 
        else if (loc === 'meds') {
            UI.show('view_meds');
        }
    }

    /* --- 3. WATER LOGIC --- */
    let water = { timer: null, timeLeft: 0, maxTime: 0, goal: 0, current: 0 };

    function initWater() {
        const w = document.getElementById('w_weight').value;
        const int = parseInt(document.getElementById('w_interval').value);
        if(!w) return alert("Enter weight");

        const liters = (w * 0.033).toFixed(1);
        const glasses = Math.ceil((liters * 1000) / 250);
        water.goal = glasses;
        water.maxTime = int * 60;
        water.timeLeft = water.maxTime;
        
        document.getElementById('w_goal').innerText = liters + 'L';
        UI.show('view_water'); // Go to Tracker
        startWaterTimer();
    }

    function startWaterTimer() {
        clearInterval(water.timer);
        updateRing();
        water.timer = setInterval(() => {
            water.timeLeft--;
            updateRing();
            if(water.timeLeft <= 0) {
                clearInterval(water.timer);
                AudioSys.trigger(translations[currentLang].alertTitle, translations[currentLang].alertBody, "Hydrate");
            }
        }, 1000);
    }

    function updateRing() {
        const m = Math.floor(water.timeLeft / 60).toString().padStart(2,'0');
        const s = (water.timeLeft % 60).toString().padStart(2,'0');
        document.getElementById('w_timer').innerText = `${m}:${s}`;
        const offset = 500 - (500 * (water.timeLeft / water.maxTime));
        document.getElementById('w_ring').style.strokeDashoffset = offset;
    }

    function addWater() {
        water.current++;
        document.getElementById('w_count').innerText = water.current;
        stopAlert();
        water.timeLeft = water.maxTime;
        startWaterTimer();
    }

    /* --- 4. MEDICATION LOGIC --- */
    let meds = [];
    const daysArr = ['S','M','T','W','T','F','S'];
    const dayCon = document.getElementById('day_selector');
    daysArr.forEach((d, i) => {
        dayCon.innerHTML += `<div class="day-pill selected" onclick="this.classList.toggle('selected')" data-idx="${i}">${d}</div>`;
    });

    function setDose(n) {
        document.querySelectorAll('.dose-btn').forEach((b,i) => b.classList.toggle('active', i+1 === n));
        const con = document.getElementById('time_inputs_container');
        con.innerHTML = '';
        for(let i=0; i<n; i++) con.innerHTML += `<input type="time" class="time-inp">`;
    }

    function openMedForm(editId = null) {
        const t = translations[currentLang];
        document.getElementById('form_title').innerText = editId ? (currentLang === 'en' ? "Edit Medication" : t.hAddMed) : t.hAddMed;
        document.getElementById('m_edit_id').value = editId || '';
        
        if(editId) {
            const m = meds.find(x => x.id === editId);
            document.getElementById('m_name').value = m.name;
            document.getElementById('m_note').value = m.note;
            setDose(m.times.length);
            setTimeout(() => {
                const inputs = document.querySelectorAll('.time-inp');
                m.times.forEach((t, i) => inputs[i].value = t);
            }, 50);
            document.querySelectorAll('.day-pill').forEach(p => {
                p.classList.toggle('selected', m.days.includes(parseInt(p.dataset.idx)));
            });
        } else {
            document.getElementById('m_name').value = '';
            document.getElementById('m_note').value = '';
            setDose(1);
            document.querySelectorAll('.day-pill').forEach(p => p.classList.add('selected'));
        }
        UI.show('view_med_form');
    }

    function cancelMedForm() { UI.show('view_meds'); }

    function saveMed() {
        const name = document.getElementById('m_name').value;
        const note = document.getElementById('m_note').value;
        const times = Array.from(document.querySelectorAll('.time-inp')).map(i => i.value).filter(v => v);
        const days = Array.from(document.querySelectorAll('.day-pill.selected')).map(p => parseInt(p.dataset.idx));
        const editId = document.getElementById('m_edit_id').value;

        if(!name || times.length === 0 || days.length === 0) return alert("Fill all details.");
        if(editId) meds = meds.filter(m => m.id != editId);

        meds.push({ id: Date.now(), name, times, days, note });
        renderMeds();
        UI.show('view_meds');
    }

    function renderMeds() {
        const con = document.getElementById('med_list_container');
        if(meds.length === 0) { con.innerHTML = `<p style="text-align:center; opacity:0.5; margin-top:50px;">${translations[currentLang].noMeds}</p>`; return; }
        
        con.innerHTML = meds.map(m => `
            <div class="med-card">
                <div class="med-info">
                    <div class="med-icon"><i class="fas fa-capsules"></i></div>
                    <div>
                        <div style="font-weight:700;">${m.name}</div>
                        <div style="font-size:0.8rem; color:var(--primary); font-weight:600;">${m.times.join(', ')}</div>
                        <div style="font-size:0.7rem; opacity:0.7;">${m.note || ''}</div>
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-icon" onclick="openMedForm(${m.id})"><i class="fas fa-pencil-alt"></i></button>
                    <button class="btn-icon" onclick="deleteMed(${m.id})" style="color:#ef4444;"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');
    }

    function deleteMed(id) { meds = meds.filter(m => m.id !== id); renderMeds(); }

    /* --- 5. AUDIO & ALERT SYSTEM --- */
    const AudioSys = {
        ctx: null, interval: null,
        init: () => { if(!AudioSys.ctx) AudioSys.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
        playTone: () => {
            if(AudioSys.ctx.state === 'suspended') AudioSys.ctx.resume();
            const o = AudioSys.ctx.createOscillator();
            const g = AudioSys.ctx.createGain();
            o.connect(g); g.connect(AudioSys.ctx.destination);
            o.type = 'sine'; o.frequency.setValueAtTime(600, AudioSys.ctx.currentTime);
            g.gain.setValueAtTime(0.5, AudioSys.ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, AudioSys.ctx.currentTime + 0.5);
            o.start(); o.stop(AudioSys.ctx.currentTime + 0.5);
        },
        speak: (txt) => {
            if('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(txt);
                u.lang = currentLang; 
                window.speechSynthesis.speak(u);
            }
        },
        trigger: (title, body, speech) => {
            document.getElementById('alert_modal').style.display = 'flex';
            document.getElementById('alert_title').innerText = title;
            document.getElementById('alert_body').innerText = body;
            const act = () => {
                AudioSys.playTone();
                if(speech) AudioSys.speak(speech);
                if(navigator.vibrate) navigator.vibrate([300, 100, 300]);
            };
            act();
            AudioSys.interval = setInterval(act, 4000);
            if(Notification.permission === 'granted') {
                new Notification(title, { body: body, icon: 'https://cdn-icons-png.flaticon.com/512/2966/2966327.png' });
            }
            if('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: title, artist: "HealthHub Alert", album: body,
                    artwork: [{ src: 'https://cdn-icons-png.flaticon.com/512/2966/2966327.png', sizes: '96x96', type: 'image/png' }]
                });
                navigator.mediaSession.playbackState = 'playing';
            }
        }
    };

    function stopAlert() {
        clearInterval(AudioSys.interval);
        if(window.speechSynthesis) window.speechSynthesis.cancel();
        document.getElementById('alert_modal').style.display = 'none';
        if('mediaSession' in navigator) navigator.mediaSession.playbackState = 'none';
    }

    setInterval(() => {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        if(now.getSeconds() === 0) {
            const tStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
            const dIdx = now.getDay();
            meds.forEach(m => {
                if(m.days.includes(dIdx) && m.times.includes(tStr)) {
                    AudioSys.trigger(translations[currentLang].alertTitle, `${m.name}`, m.note || m.name);
                }
            });
        }
    }, 1000);

    setDose(1);
</script>
</body>
</html>
